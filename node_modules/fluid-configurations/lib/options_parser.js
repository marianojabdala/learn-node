/**
 * Parses user options and sets the defaults that are common
 * between indexing, downloading and processing methods.
 */

var _ = require("lodash"),
  idAttributes = ["customer", "catalog", "product"],
  whereAttributes = [
    "environment", "workflow"
  ].concat(idAttributes),

  getIdAsInt;

module.exports = function (userOptions) {
  var options = _.defaults({}, userOptions, {
      environment: "prod",
      where: {}
    });


  idAttributes.forEach(function (idAttribute) {
    var idAttributePlural = idAttribute + "s";
    if (options[idAttributePlural]) {
      if (_.isString(options[idAttributePlural])) {
        options[idAttributePlural] = _.map(options[idAttributePlural].split(","), getIdAsInt);
      } else if (_.isNumber(options[idAttributePlural])) {
        options[idAttributePlural] = [options[idAttributePlural]];
      }
    }

    if (!options[idAttributePlural] && options[idAttribute]) {
      options[idAttributePlural] = [getIdAsInt(options[idAttribute])];
    }
  });

  whereAttributes.forEach(function (type) {
    var value = userOptions[type] || userOptions[type + "Id"];
    if (idAttributes.indexOf(type) !== -1) {
      type = type + "Id";
    }
    if (value) {
      options.where[type] = value;
    }
  });

  return options;
};


getIdAsInt = function (id) {
  return parseInt((id + "").replace(/[^\d]+/g, ""), 10);
};
