/**
 * Links cas and vrs
 */

var _ = require("lodash");

function linkRelatedCas(options, ca, caIdString) {
  var getIdAsInt = options.utils.getIdAsInt,
    caId = getIdAsInt(caIdString),
    ownerCaId = "ca:" + caId;

  _.each(ca.sympatheticRelations || [], function (stringifiedId) {

    options.graph.edges.push({
      from: ownerCaId,
      to: "ca:" + getIdAsInt(stringifiedId),
      type: "isSympatheticWith"
    });

  });

}


function linkCaSympatheticRelations(options) {
  function processCa(ca, id) {
    if (ca.sympatheticRelations) {
      linkRelatedCas(options, ca, id);
    }
    // Handle subAttributes
    if (ca.subAttributes) {
      _.each(ca.subAttributes, function (ca, caId) {
        processCa(ca, caId);
      });
    }
  }
  _.each(options.config.attributes, function (ca, caId) {
    processCa(ca, caId);
  });
}

module.exports = function (options) {
  linkCaSympatheticRelations(options);
  return options;
};
