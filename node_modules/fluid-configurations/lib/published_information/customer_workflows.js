/**
 * Gets a list of workflows available for a given environment
 * and customer id.
 *
 * Example:
 *
 *    getCustomerWorkflows({environment: "prod", customerId: 443}, function (err, workflows) {
 *      if (err) { return console.error(err); }
 *      console.log(workflows);
 *    });
 *
 * which produces:
 *
 *    ["qa", "prod", "dev-impl"]
 */

var getCustomerWorkflows,
  _ = require("lodash"),
  getCustomerIdsAndWorkflows = require("./customer_ids_and_workflows"),
  memoize = require("../memoizer");

getCustomerWorkflows =  function getCustomerWorkflows(options, callback) {

  options = options || {};
  getCustomerIdsAndWorkflows(_.pick(options, "environment"), function (err, result) {
    if (err) { return callback(err); }
    if (!result[options.customerId]) { return callback(new Error("Customer " + options.customerId + " not found")); }
    callback(null, result[options.customerId].workflows);
  });
};

module.exports = memoize(getCustomerWorkflows, [
  "customers", "environment",
  "productId", "customer", "product", "products",
  "customerId", "entryPrimaryKey"
]);
