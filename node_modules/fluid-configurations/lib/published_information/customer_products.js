/**
 * Gets all the products for a customer environment. If no workflow
 * is provided, all the workflows will be included.
 *
 * Example:
 *
 *    getCustomerProducts({environment: "prod", "customerId": 1475}, function (err, workflows) {
 *      if (err) { return console.error(err); }
 *      console.log(workflows);
 *    });
 *
 * which produces:
 *
 *    {
 *      "7": {
 *        "environment": "prod",
 *        "customerId": 1475,
 *        "productId": 7,
 *        "workflows": [
 *          "af",
 *          "dev-impl",
 *          "prod",
 *          "qa",
 *          "socket-test"
 *        ]
 *      }
 *    }
 */

var getCustomerProducts,
  getPublishedEntities = require("../s3").getPublishedEntities,
  _ = require("lodash"),
  memoize = require("../memoizer"),
  default_options = {
    entryPrimaryKey: "productId"
  };

getCustomerProducts = function getCustomerProducts(options, callback) {

  getPublishedEntities(
    _.defaults({}, options, default_options),
    {
      Prefix: options.environment +
        "/{WORKFLOW}/customers/c" +
        options.customerId +
        "/configureHtml/products/p_"
    },
    callback
  );
};

module.exports = memoize(getCustomerProducts, [
  "product", "customers", "products", "environment",
  "customerId", "productId", "workflows", "workflow"
]);
