/**
 * Gets a list of workflows available for a given environment
 * customer id and product id.
 *
 * Example:
 *
 *    getCustomerProductWorkflows({environment: "prod", customerId: 443}, function (err, workflows) {
 *      if (err) { return console.error(err); }
 *      console.log(workflows);
 *    });
 *
 * which produces:
 *
 *    ["qa", "prod", "dev-impl"]
 */

var getCustomerProductWorkflows,
  _ = require("lodash"),
  getCustomerProducts = require("./customer_products"),
  memoize = require("../memoizer");

getCustomerProductWorkflows =  function getCustomerProductWorkflows(options, callback) {

  getCustomerProducts(_.omit(options, ["workflow", "workflows"]), function (err, result) {
    if (err) { return callback(err); }
    if (!result[options.productId]) { return callback(new Error("Product " + options.productId + " not found")); }
    callback(null, result[options.productId].workflows);
  });
};


module.exports = memoize(getCustomerProductWorkflows,
    ["products", "product", "workflow",
      "workflows", "customers", "environment",
      "productId", "customerId"
    ]);
