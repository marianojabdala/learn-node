var jsonpClient = require("jsonp-client"),
  writeAndTouch = require("../write_and_touch"),
  fs = require("fs");

module.exports = function (options, callback) {

  // TODO: Only process jsonp files

  var mtime = new Date(options.s3Object.LastModified);

  fs.stat(options.json_file, function (err, stats) {
    if (stats && stats.mtime && stats.mtime.toString() === mtime.toString()) {
      // debug("[info] Up to date JSON processor %s", options.json_file);
      return callback(null, {files: [options.json_file]});
    }

    jsonpClient(options.admin_published_file, function (err, json) {
      if (err) { return callback(err); }
      writeAndTouch(options.json_file, JSON.stringify(json), mtime, function (err) {
        callback(err, {files: [options.json_file]});
      });
    });

  });
};

