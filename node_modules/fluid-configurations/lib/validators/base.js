/* jshint -W100 */

var jsonSchemaValidator = require("amanda")("json"),
  _ = require("lodash"),
  doctor = require("../doctor"),
  // Amanda wraps attribute names in smarty quotes, those can break
  // JSON parsing in old browsers.
  smartyQuoteRegexp = new RegExp("‘|’", "g");

module.exports = function (schema, schemaDescription, itemPrimaryKey) {
  return function (json, callback) {
    jsonSchemaValidator.validate(json, schema, function (errors) {
      var err,
        messages = [];
      if (errors && errors.length > 0) {
        _.each(errors, function (error) {
          messages.push(error.message.replace(smartyQuoteRegexp, "'"));
        });
        doctor.addIssue("%s %s schema validation failed with errors: %j", schemaDescription, json[itemPrimaryKey], messages);
        err = new Error(schemaDescription + " schema validation failed with errors:\n - " + messages.join("\n - "));
      }
      callback(err, messages);
    });
  };
};


