# Fluid Configurations

Downloads, migrates, validates and processes published configuration files

![Fluid CI Build Status](http://hubot.fluidretail.net/badge/fluid-configurations/build.png) ![Fluid CI Code Coverage](http://hubot.fluidretail.net/badge/fluid-configurations/coverage.png) ![Fluid CI Dependencies](http://hubot.fluidretail.net/badge/fluid-configurations/dependencies.png)


The `fluid-configurations` module allows you
to download configurations published by the admin, analyze them
and generate new configuration types that can be used
by internal tools in order to access configuration data
in a more efficient way.

By default configurations are published on the fluid-configurations
s3 bucket and distributed via the CDN endpoint
dlotr6nyt8a8f.cloudfront.net for browser usage.

## Getting started

### Requisites

- AWS credentials [properly set in your system](http://docs.aws.amazon.com/AWSJavaScriptSDK/guide/node-configuring.html#Setting_AWS_Credentials).
- [Node.js](http://nodejs.org/)
- A Bitbucket account with properly setup ssh credentials for checking out fluidretail's code.


### Installation CLI

    npm install git+ssh://git@bitbucket.org/fluidretail/fluid-configurations.git -g

Depending on how you've setup Node.js you might need to run npm
with administrator rights.

## Usage

    $ fluid-configurations --help

    Usage: fluid-configurations [index,download,process,upload,sync,help] [options]

    Commands:

      index [options]        Retrieves an index of published configurations
      download [options]     Downloads published configurations
      process [options]      Process published configurations and save them locally
      upload [options]       Uploads processed configuration files to S3
      sync [options]         Syncs, optimizes and uploads published files
      help                   Shows help for the commands: index, download, process, upload, sync

    Options:

      -h, --help     output usage information
      -V, --version  output the version number


### Commands documentation

You can get help for each command by running

    fluid-configurations help command-name

The following commands are available:

- [index](https://bitbucket.org/fluidretail/fluid-configurations/src/master/docs/cli/index.md)
- [download](https://bitbucket.org/fluidretail/fluid-configurations/src/master/docs/cli/download.md)
- [process](https://bitbucket.org/fluidretail/fluid-configurations/src/master/docs/cli/process.md)
- [upload](https://bitbucket.org/fluidretail/fluid-configurations/src/master/docs/cli/upload.md)
- [sync](https://bitbucket.org/fluidretail/fluid-configurations/src/master/docs/cli/sync.md)


## Installation Node.js

    npm install git+ssh://git@bitbucket.org/fluidretail/fluid-configurations.git --save

## Usage Node.js

Include the library on Node.js

```javascript
var fluidConfigurations = require("fluid-configurations"),
  options = {
    environment: "prod",
    customer: 1443
  };

// Gets a full index for all the configuration assets published on S3
fluidConfigurations.getPublishedIndexes(options, function (err, indexes) {

  // Downloads all the configuration files included on the indexes
  fluidConfigurations.downloadConfigurations({
    indexes: indexes,
    local_dir: path.normalize("./data")
  }, function (err) {

    // Runs a list of processors on downloaded configurations
    fluidConfigurations.processConfigurations({
      indexes: indexes,
      local_dir: path.normalize("./data"),
      // optional list of processors, by default
      // all the processors on config/processors.json will be
      // included. The json processor will be always included.
      processors: ["json", "catalog",
        "optimized_report", "product",
        "relationships", "preferences"]
    }, function (err) {

      // Uploads processed files to S3
      fluidConfigurations.uploadToS3({
        indexes: indexes,
        local_dir: path.normalize("./data"),
        s3: {
          bucket: "fluid-sandbox",
          prefix: "bermi/configurations/"
        }
      }, function (err) {

          // All done
      });

    });

  });

});
```

## Module overview

This module downloads published configurations and analyzes them in order
to build custom configurations that can be used in specialized environments.

The following description has been copied from the story DEV-2567 as this README.md file might outlive Jira.

The admin publishes configure configuration files to s3://fluid-configure-published.

Configuration files are only updated when customers publish their products and catalogs into workflows. This creates a situation where our runtime and server side code that uses those configurations has to keep backwards compatibility with old and sometime erroneous configurations that cant be updated because our customers might have an unpublishable state on their admin data.

This module creates a local snapshot of all the configurations and transverse them to generate new configuration types without requiring re-publishes.

### Benefits and features

#### Generation of JSON configurations

We can now use CORS on our s3 buckets in order to serve JSON files instead of JSONp.

The main benefit is the avoidance of callback naming conventions (our callbacks are static) that have been the source of some bugs in the past.

Another benefit is that we simplify server side access to configuration files by removing a parse/replace and evaluation step.

On the runtime this will also get rid of the fatal error that occurs when we try to access a non existent jsonp file, if the file has a js syntax error or if there are jsonp callback clashes like the ones we had in the past.

### Validation, data integrity checks and migrations

Post processing steps can identify issues that where not initially validated on the admin and can help us to create migrations for configurations on a post processing step rather than at the implementation level.

This module makes use of the JSONschema standard for describing newly
generated configuration files. This will give us a good deal of confidence on the integrity of the publishes.

An array with know "issues" should be attached to newly generated configuration files.

### Generation of optimized configurations.

For example, the catalog needs information about products included on the catalog, the catalog and customer configuration, the Cloud Search index configuration and all the locales.

For some customer like Reebok this sums up to 800 files and 200MB worth of configurations (and growing), therefore we need to generate a unified configuration that allows us to build a catalog context on our servers and on the runtime js in order to offer decent performance.


#### Mobile optimized configurations

The upcoming DEV-2302 requires us to optimize configure for mobile devices. One way is to merge common configuration files (localization, product, customer....) for a given context (product, catalog...) into a single smaller config.


### Removing localization logic from server and client processing logic

Right now we are loading multiple localization configuration files (customer, product, catalog, templates) and we are merging and creating a dictionary in memory.

We can greatly simplify our code if we serve localized configuration files that do all the merging during the post publish process. As a side effect will also improve performance and bugs.

#### Testability, support and development improvements

Having the ability to create snapshot of configurations makes it simpler for developers to analyze, test, validate and use the configurations in ways that where not possible so far.

For example we can quickly and progamatically verify who is using a given setting by doing a search on the configuration files. This can help us understand better who or what needs to be tested when we make changes on our code.

It also allows us to generate test cases and feed the inspector list of implementations and products automatically.




## Environment variables

The default behavior of the library can be customized via the following
environment variables:

- FLUID_SKIP_S3_LIST_MEMOIZATION: When defined the application will
  not cache the requests made to S3. This will result in slower
  performance but might be required if you are running the module
  on a long lived runtime or during testing.
- FLUID_S3_INDEXER_CONCURRENCY: How many concurrent S3 API clients
  do we want to use? The default is to use 5 clients in parallel.
- SKIP_PROCESSED_VERSION_PATHS: By default processed files will
  be prefixed by the semver of this package.
  This allow us to generate different version of the configuration
  files between releases adapting them to the need of the consumer
  applications.

## Testing

```bash
make
```

### Continuous linting and testing

```bash
make dev
```

## Releasing new versions

```bash
make release
```

The tasks release (same as release-patch), release-minor and release-major should be
used for pushing new versions of the code.

## License

Copyright (c) 2014 Fluid Inc, All rights reserved.