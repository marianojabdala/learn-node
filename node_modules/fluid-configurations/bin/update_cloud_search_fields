#!/usr/bin/env node

var AWS = require("aws-sdk"),
  cloudSearch,
  _ = require("lodash"),
  getDomainNames,
  exec = require("child_process").exec,
  async = require("async"),
  cloudSearchConfigs = require(__dirname + "/../config/cloud_search.json"),
  fs = require("fs"),
  path = require("path");

cloudSearch = new AWS.CloudSearch({
  // apiVersion: "2011-02-01",
  region: "us-east-1"
});


getDomainNames = function (callback) {
  cloudSearch.listDomainNames({}, function (err, data) {
    if (err) {
      return callback(err);
    }
    callback(null, data);
  });
};


/**
 * Cloud search 2011-02-01 API does not allow us to fetch
 * a domain name index fields, for this reason we have
 * to use the SLOW cs-describe-domain command in order to generate
 * a static representation of search domain fields by calling
 * this binary
 */
getDomainNames(function (err, domains) {
  var domainNames = (process.env.UPDATE_CLOUD_SEARCH_INDEXES || "").replace("true", "").split(",");

  if (domainNames.length === 0 || domainNames[0] === "") {
    domainNames = _.keys(domains.DomainNames);
  }

  async.eachSeries(domainNames, function (domain, callback) {
    var cmd = "cs-describe-domain --domain-name " + domain + " --show-all";

    exec(cmd, function (err, stdout, stderr) {

      if (err) {
        console.log("Failed running: " + cmd);
        console.log("stdout", stdout);
        console.log("stderr", stderr);
        return callback(err);
      }
      // console.log(arguments);

      var i, line,
        lines = stdout.toString().split("\n"),
        fields = [],
        capture;

      for (i = 0; lines.length > i; i += 1) {
        line = lines[i];

        if (line.indexOf("=======") !== -1) {
          capture = false;
        }

        if (capture) {
          fields.push(line.substr(0, line.indexOf(" ")));
        } else if (line === "=======") {
          capture = true;
        }
      }

      cloudSearchConfigs[domain] = cloudSearchConfigs[domain] || {};
      cloudSearchConfigs[domain].fields = fields;

      // console.log(cloudSearchConfigs);

      callback(err, fields);
    });
  }, function (err) {
    if (err) {
      console.log(err);
    }
    fs.writeFile(path.normalize(__dirname + "/../config/cloud_search.json"), JSON.stringify(cloudSearchConfigs, null, 2), function () {
      console.log("done updating config/cloud_search.json");
    });
  });
});
